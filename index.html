<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Speed Cube ‚Äì Neon Run (Varied Obstacles)</title>
<style>
  :root{
    --bg:#0a0d17; --fg:#eaf2ff; --muted:#7f8aa3;
    --c1:#00e5ff; --c2:#8a2eff; --c3:#00ff85; --c4:#ff3366;
    --line:#21304a; --ui:#101624; --btn:#172136; --btn2:#0e1628;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto}
  #game{display:block;width:100%;height:100%;touch-action:none;background:linear-gradient(180deg,#0a0d17 0%,#0a0d17 50%,#0b0f1c 100%)}
  .hud{position:fixed;left:0;right:0;top:0;display:flex;justify-content:space-between;gap:8px;padding:10px 12px;pointer-events:none}
  .chip{pointer-events:auto;background:rgba(16,22,36,.85);border:1px solid #1b2740;border-radius:12px;padding:8px 12px;backdrop-filter:blur(6px);box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex;gap:8px;align-items:center}
  .btn{pointer-events:auto;background:var(--btn);border:1px solid #21304a;color:#dce7ff;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#23355a,#182542);border-color:#2a3b61}
  .center{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none}
  .panel{pointer-events:auto;max-width:min(92vw,520px);background:rgba(16,22,36,.92);border:1px solid #23355a;border-radius:16px;padding:18px 18px 14px;box-shadow:0 14px 50px rgba(0,0,0,.45)}
  h1{margin:.2rem 0 .6rem;font-size:28px}
  .muted{color:var(--muted)} .lvl{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .lvl button{flex:1 0 80px;background:var(--btn2);border:1px solid #243356;color:#cfe1ff;border-radius:12px;padding:10px 12px;cursor:pointer}
  .lvl button.lock{opacity:.45;cursor:default}
  .kbd{display:inline-flex;align-items:center;gap:6px;background:#11192c;border:1px solid #23355a;border-radius:10px;padding:6px 10px;font-size:13px;color:#cfe1ff}
  .hint{position:fixed;left:0;right:0;bottom:8px;text-align:center;color:#7e8aa6;font-size:12px;opacity:.8}
</style>
</head>
<body>
<div id="wrap"><canvas id="game"></canvas></div>

<!-- HUD -->
<div class="hud">
  <div class="chip"><b>Szint:</b> <span id="hudLevel">1</span> ‚Ä¢ <b>K√≠s√©rlet:</b> <span id="hudTry">1</span></div>
  <div class="row">
    <button class="btn" id="bPause">Sz√ºnet</button>
    <button class="btn" id="bMute">üîä</button>
  </div>
</div>

<!-- √Ållapot panelek -->
<div class="center" id="stateLayer">
  <div class="panel" id="pMenu" style="display:none">
    <h1>Speed Cube <span style="color:var(--c1)">NEON</span></h1>
    <p class="muted">Ugr√°s: <span class="kbd">SPACE</span> / √©rint√©s. √öj akad√°lyok: t√ºsk√©k, f≈±r√©szek, liftek √©s szakad√©kok.</p>
    <div class="lvl" id="levelGrid"></div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="bStart">J√°t√©k ind√≠t√°sa</button>
      <button class="btn" id="bHow">Ir√°ny√≠t√°s</button>
    </div>
  </div>
  <div class="panel" id="pHow" style="display:none">
    <h1>Ir√°ny√≠t√°s</h1>
    <p class="muted">‚Ä¢ Ugr√°s: <span class="kbd">SPACE</span> / √©rint√©s<br>‚Ä¢ Hosszan: lebeg√©s (kisebb gravit√°ci√≥)<br>‚Ä¢ √útk√∂z√©s = restart</p>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="bBackHow">Vissza</button>
      <button class="btn primary" id="bPlayNow">Mehet</button>
    </div>
  </div>
  <div class="panel" id="pFail" style="display:none">
    <h1>üí• √útk√∂zt√©l!</h1>
    <p class="muted">Megpr√≥b√°lod √∫jra?</p>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" id="bRetry">√öjrapr√≥b√°lom</button>
      <button class="btn" id="bMenu1">Men√º</button>
      <button class="btn" id="bWatch">‚ñ∂ Folytat√°s (rekl√°m)</button>
    </div>
  </div>
  <div class="panel" id="pWin" style="display:none">
    <h1>üèÅ Szint teljes√≠tve!</h1>
    <p class="muted">K√©szen √°llsz a k√∂vetkez≈ëre?</p>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" id="bNext">K√∂vetkez≈ë szint</button>
      <button class="btn" id="bMenu2">Men√º</button>
    </div>
  </div>
  <div class="panel" id="pPause" style="display:none">
    <h1>Sz√ºnet</h1>
    <p class="muted">A j√°t√©k meg√°llt.</p>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" id="bResume">Folytat√°s</button>
      <button class="btn" id="bMenu3">Men√º</button>
    </div>
  </div>
</div>

<div class="hint">Tipp: √©rint√©s vagy SPACE az ugr√°shoz ‚Ä¢ Hosszan: lebeg√©s ‚Ä¢ √öj akad√°lyt√≠pusok akt√≠vak</div>

<script>
(()=>{
  /* ===== Ad/Analytics hookok ===== */
  const Ads = {
    onLevelStart(l){}, onLevelEnd(l,t,tries){},
    async watchToContinue(){ return new Promise(res=>setTimeout(()=>res(true),900)); }
  };

  /* ===== Canvas ===== */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  function fit(){ const w=innerWidth,h=innerHeight; canvas.width=w*DPR; canvas.height=h*DPR; canvas.style.width=w+'px'; canvas.style.height=h+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
  fit(); addEventListener('resize', fit);

  /* ===== UI ===== */
  const $=s=>document.querySelector(s);
  const hudLevel=$('#hudLevel'), hudTry=$('#hudTry');
  const pMenu=$('#pMenu'), pHow=$('#pHow'), pFail=$('#pFail'), pWin=$('#pWin'), pPause=$('#pPause'), layer=$('#stateLayer');
  function showPanel(el){ [pMenu,pHow,pFail,pWin,pPause].forEach(p=>p.style.display='none'); if(el){ el.style.display='block'; layer.style.display='grid'; } else layer.style.display='none'; }

  /* ===== J√°t√©kparam√©terek ===== */
  const G={ gravity:2200, jump:720, airHold:0.45, groundY:0, speedBase:260, speedGain:24 };
  const LEVEL_COUNT=12;
  const palList=[ ['#00e5ff','#8a2eff','#00ff85','#ff3366'], ['#ffd166','#06d6a0','#118ab2','#ef476f'], ['#ff8fab','#b8c0ff','#80ed99','#f7b801'], ['#72ddf7','#8093f1','#f17300','#ef476f'] ];
  let unlocked=+localStorage.getItem('neon_unlocked2')||1;

  /* ===== Szint gener√°tor (vegyes akad√°lyok) ===== */
  // t√≠pusok: box | spike | saw | moving | pit
  function makeLevel(idx){
    const speed=G.speedBase+(idx-1)*G.speedGain;
    const length=3000+idx*450;
    const obstacles=[];
    let x=560;
    function add(o){ obstacles.push(o); }
    // s≈±r≈±s√©g n≈ë: nagyobb idx ‚Üí t√∂bb elem
    while(x<length){
      const r=Math.random();
      if(r<0.18){ // szakad√©k
        const w=120+Math.random()* (80+idx*4);
        add({type:'pit', x, w});
        x+=w+160+Math.random()*140;
      }else if(r<0.42){ // spike
        const w=60+Math.random()*40, h=80+Math.random()* (30+idx*3);
        add({type:'spike', x, w, h});
        x+=140+Math.random()*140;
      }else if(r<0.62){ // saw
        const r0=24+Math.random()*18;
        add({type:'saw', x, r:r0, yOffset: - (40+Math.random()*60), spin:(Math.random()<.5?-1:1)*(2+Math.random()*2)});
        x+=170+Math.random()*160;
      }else if(r<0.82){ // moving pillar
        const w=36+Math.random()*30, h=90+Math.random()* (40+idx*2);
        add({type:'moving', x, w, h, amp: 30+Math.random()*50, freq: 1+Math.random()*1.2, phase: Math.random()*Math.PI*2});
        x+=170+Math.random()*150;
      }else{ // box
        const w=40+Math.random()*50, h=80+Math.random()* (40+idx*2);
        add({type:'box', x, w, h});
        x+=150+Math.random()*140;
      }
    }
    const pal=palList[(idx-1)%palList.length];
    return {idx,speed,length,obstacles,pal};
  }
  const levels=Array.from({length:LEVEL_COUNT},(_,i)=>makeLevel(i+1));

  /* ===== √Ållapot ===== */
  let state='menu', muted=false;
  const player={x:120,y:0,w:36,h:36,vy:0,onGround:false};
  let camX=0, level=null, tryCount=1, elapsed=0, tPrev=0;

  const beep=(()=>{ let a=null; return (f=880,d=0.05)=>{ if(muted) return; try{ a=a||new (window.AudioContext||window.webkitAudioContext)(); const o=a.createOscillator(), g=a.createGain(); o.connect(g); g.connect(a.destination); o.type='square'; o.frequency.value=f; g.gain.value=.02; o.start(); setTimeout(()=>o.stop(), d*1000);}catch(e){} }; })();

  function resetPlayer(){ player.y=G.groundY-player.h; player.vy=0; player.onGround=true; camX=0; elapsed=0; }
  function start(idx){ level=levels[idx-1]; G.groundY=Math.round(innerHeight*0.72); resetPlayer(); tryCount=1; hudLevel.textContent=level.idx; hudTry.textContent=tryCount; state='playing'; showPanel(null); Ads.onLevelStart(level.idx); }
  function restart(){ resetPlayer(); tryCount++; hudTry.textContent=tryCount; state='playing'; showPanel(null); }
  function nextLevel(){ const nxt=Math.min(LEVEL_COUNT,(level?.idx||1)+1); if(nxt>unlocked){ unlocked=nxt; localStorage.setItem('neon_unlocked2',unlocked); } renderLevelButtons(); start(nxt); }

  /* ===== Input ===== */
  let pressing=false, justPressed=false;
  function press(){ if(state==='menu'){ start(1); return; } pressing=true; justPressed=true; }
  function release(){ pressing=false; }
  addEventListener('keydown',e=>{ if(e.code==='Space'){ e.preventDefault(); press(); }});
  addEventListener('keyup',e=>{ if(e.code==='Space'){ e.preventDefault(); release(); }});
  canvas.addEventListener('pointerdown',e=>{ e.preventDefault(); press(); });
  addEventListener('pointerup',e=>{ release(); });

  // UI gombok
  $('#bStart').onclick=()=>showPanel(pMenu); $('#bHow').onclick=()=>showPanel(pHow);
  $('#bBackHow').onclick=()=>showPanel(pMenu); $('#bPlayNow').onclick=()=>start(1);
  $('#bRetry').onclick=()=>restart();
  $('#bMenu1').onclick=$('#bMenu2').onclick=$('#bMenu3').onclick=()=>{ state='menu'; showPanel(pMenu); };
  $('#bNext').onclick=()=>nextLevel();
  $('#bPause').onclick=()=>{ if(state==='playing'){ state='pause'; showPanel(pPause);} };
  $('#bResume').onclick=()=>{ if(state==='pause'){ state='playing'; showPanel(null);} };
  $('#bMute').onclick=(e)=>{ muted=!muted; e.currentTarget.textContent=muted?'üîá':'üîä'; };
  $('#bWatch').onclick=async()=>{ const ok=await Ads.watchToContinue(); if(ok){ showPanel(null); state='playing'; player.x+=20; } };

  /* ===== Seg√©dek rajzhoz ===== */
  function neonRect(x,y,w,h,c,g=12){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); ctx.shadowColor=c; ctx.shadowBlur=g; ctx.strokeStyle=c; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1); ctx.shadowBlur=0; }
  function neonTri(x,y,w,h,c){ ctx.fillStyle=c; ctx.beginPath(); ctx.moveTo(x,y+h); ctx.lineTo(x+w/2,y); ctx.lineTo(x+w,y+h); ctx.closePath(); ctx.fill(); ctx.shadowColor=c; ctx.shadowBlur=12; ctx.strokeStyle=c; ctx.stroke(); ctx.shadowBlur=0; }
  function neonCircle(cx,cy,r,c){ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.closePath(); ctx.fillStyle=c; ctx.fill(); ctx.shadowColor=c; ctx.shadowBlur=12; ctx.strokeStyle=c; ctx.stroke(); ctx.shadowBlur=0; }
  function drawGround(){ ctx.strokeStyle='rgba(33,48,74,.55)'; ctx.lineWidth=1; for(let y=G.groundY;y<canvas.height;y+=12){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); } }

  /* ===== √útk√∂z√©s seg√©dek ===== */
  function rectHit(ax,ay,aw,ah,bx,by,bw,bh){ return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by; }
  function rectCircleHit(rx,ry,rw,rh,cx,cy,cr){
    const nx=Math.max(rx, Math.min(cx, rx+rw));
    const ny=Math.max(ry, Math.min(cy, ry+rh));
    const dx=cx-nx, dy=cy-ny;
    return dx*dx+dy*dy <= cr*cr;
  }
  // Spike: a j√°t√©kos alj√°nak k√∂z√©ppontj√°t hasonl√≠tjuk a h√°romsz√∂g "tet≈ë" profilj√°hoz
  function spikeHit(px,py,pw,ph, tx,ty,tw,th){
    const cx=px+pw/2, by=py+ph; // player bottom-center
    if(cx<tx || cx>tx+tw || by<ty || by>ty+th) return false;
    const mid=tx+tw/2;
    const dy = Math.abs(cx-mid)*(th/(tw/2));
    const yAt = ty + dy;
    return by >= yAt - 0.5; // kis engedm√©ny
  }

  /* ===== Talaj logika szakad√©kkal ===== */
  function worldXfromScreen(sx){ return camX - 160 + sx; }
  function localGroundYAt(playerWorldX){
    // ha b√°rmelyik pit (szakad√©k) alatt √°llunk ‚Üí nincs talaj
    for(const o of level.obstacles){
      if(o.type!=='pit') continue;
      if(playerWorldX >= o.x && playerWorldX <= o.x+o.w) return Infinity; // ‚Äûleesik‚Äù
    }
    return G.groundY;
  }

  /* ===== Game loop ===== */
  function step(dt){
    if(state!=='playing') return;
    const L=level, speed=L.speed;
    elapsed+=dt; camX+=speed*dt;

    // Ugr√°s / lebeg√©s
    if(justPressed && player.onGround){ player.vy=-G.jump; player.onGround=false; beep(880); }
    justPressed=false;
    const grav=pressing? G.gravity*(1-G.airHold) : G.gravity;
    player.vy+=grav*dt; player.y+=player.vy*dt;

    // Talaj (szakad√©kkal)
    const pWorld=worldXfromScreen(player.x);
    const gY=localGroundYAt(pWorld);
    if(gY!==Infinity){
      if(player.y+player.h>=gY){ player.y=gY-player.h; player.vy=0; player.onGround=true; }
    }else{
      // se talaj ‚Üí ha t√∫l m√©lyre esik, fail
      if(player.y>canvas.height+200){ fail(); return; }
    }

    // Akad√°lyok √ºtk√∂z√©s
    for(const o of L.obstacles){
      const sx = Math.round(o.x - camX + 160);
      if(sx>canvas.width+120 || sx< -240) continue;

      if(o.type==='box'){
        const oy=G.groundY - o.h;
        if(rectHit(player.x,player.y,player.w,player.h, sx,oy,o.w,o.h)) return fail();
      }
      if(o.type==='moving'){
        const oy=G.groundY - o.h + Math.sin(elapsed*o.freq + o.phase)*o.amp;
        if(rectHit(player.x,player.y,player.w,player.h, sx,oy,o.w,o.h)) return fail();
      }
      if(o.type==='spike'){
        const oy=G.groundY - o.h;
        if(spikeHit(player.x,player.y,player.w,player.h, sx,oy,o.w,o.h)) return fail();
      }
      if(o.type==='saw'){
        const cy = G.groundY + o.yOffset + Math.sin(elapsed*1.2)*6;
        const cx = sx + o.r + 10;
        if(rectCircleHit(player.x,player.y,player.w,player.h, cx,cy,o.r)) return fail();
      }
      // pit-n√©l a talajt m√°r a localGroundYAt kezeli
    }

    // C√©l
    if(camX>L.length){ win(); }
  }

  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // h√°tt√©r grid
    ctx.strokeStyle='rgba(33,48,74,.55)'; ctx.lineWidth=1;
    for(let x=(- (camX%40)); x<canvas.width; x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
    for(let y=0;y<canvas.height;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }

    drawGround();

    // player
    neonRect(player.x,player.y,player.w,player.h,'#00e5ff',18);

    if(level){
      const C=level.pal;
      // akad√°lyok
      let i=0;
      for(const o of level.obstacles){
        const sx = Math.round(o.x - camX + 160);
        if(sx>canvas.width+200 || sx< -260){ i++; continue; }
        const col = C[i++ % C.length];

        if(o.type==='box'){
          const oy=G.groundY - o.h; neonRect(sx,oy,o.w,o.h,col,14);
        }else if(o.type==='moving'){
          const oy=G.groundY - o.h + Math.sin(elapsed*o.freq + o.phase)*o.amp;
          neonRect(sx,oy,o.w,o.h,col,14);
        }else if(o.type==='spike'){
          const oy=G.groundY - o.h; neonTri(sx,oy,o.w,o.h,col);
        }else if(o.type==='saw'){
          const cy = G.groundY + o.yOffset + Math.sin(elapsed*1.2)*6;
          const cx = sx + o.r + 10;
          ctx.save();
          ctx.translate(cx,cy); ctx.rotate(elapsed*o.spin); neonCircle(0,0,o.r,col); // forg√°s
          ctx.restore();
        }else if(o.type==='pit'){
          // rajz: s√∂t√©tebb ‚Äûlyuk‚Äù √©s perem f√©ny
          const y=G.groundY; const w=o.w;
          ctx.fillStyle='rgba(10,13,23,.95)'; ctx.fillRect(sx,y,w,canvas.height-y);
          ctx.strokeStyle='rgba(0,229,255,.35)'; ctx.beginPath(); ctx.moveTo(sx,y+1); ctx.lineTo(sx+w,y+1); ctx.stroke();
        }
      }

      // progress bar
      const p = Math.max(0, Math.min(1, camX/level.length));
      const barW=Math.min(canvas.width*0.6,320), barX=(canvas.width-barW)/2, barY=18;
      ctx.fillStyle='rgba(16,22,36,.7)'; ctx.fillRect(barX,barY,barW,6);
      ctx.fillStyle='#00e5ff'; ctx.fillRect(barX,barY,barW*p,6);
      ctx.strokeStyle='#21304a'; ctx.strokeRect(barX+0.5,barY+0.5,barW-1,5);
    }
  }

  function fail(){ beep(220); state='fail'; showPanel(pFail); Ads.onLevelEnd(level.idx, elapsed, tryCount); }
  function win(){ beep(1320); state='win'; showPanel(pWin); if(level.idx+1>unlocked){ unlocked=level.idx+1; localStorage.setItem('neon_unlocked2',unlocked); } Ads.onLevelEnd(level.idx, elapsed, tryCount); renderLevelButtons(); }

  function loop(ts){ const t=ts/1000, dt=Math.min(0.033, t-(loop.t||t)); loop.t=t; if(state==='playing') step(dt); render(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  /* ===== Men√º / szintgombok ===== */
  const levelGrid=$('#levelGrid');
  function renderLevelButtons(){
    levelGrid.innerHTML='';
    levels.forEach(L=>{
      const b=document.createElement('button');
      b.textContent='Szint '+L.idx;
      if(L.idx>unlocked){ b.classList.add('lock'); b.textContent+=' üîí'; }
      b.onclick=()=>{ if(L.idx<=unlocked) start(L.idx); };
      levelGrid.appendChild(b);
    });
  }
  renderLevelButtons(); showPanel(pMenu);
})();
</script>
</body>
</html>
